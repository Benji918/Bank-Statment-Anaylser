name: Development Deployment Workflow

on:
  push:
    branches:
      - dev

jobs:
  dev-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Deploy To Droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DIGITALOCEAN_DROPLET_IP }}
          username: root
          key: ${{ secrets.DIGITALOCEAN_SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üîÑ Starting deployment..."
            
            # Install PM2 if not already installed
            if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2..."
                npm install -g pm2
            fi
            
            # Check if the directory exists
            if [ -d "$HOME/Bank-Statment-Anaylser" ]; then
              echo "Directory 'Bank-Statment-Anaylser' exists....."
            fi
            
            echo "Pulling repository changes..."
            cd $HOME/Bank-Statment-Anaylser
            
            # Create .env file on the droplet
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # Ensure we're on the right branch
            git reset --hard HEAD
            git clean -fd
            git fetch origin dev
            git checkout dev
            git pull origin dev
            echo "‚úì Git changes pulled"
            
            # FORCE RECREATE VENV WITH PYTHON 3.11
            if [ -d "venv" ]; then
                echo "Removing existing virtual environment..."
                rm -rf venv
            fi
            echo "Creating new virtual environment with Python 3.11..."
            python3.11 -m venv venv
            
            source venv/bin/activate
            echo "‚úì Activated virtual environment (Python 3.11)"
            
            # Always install requirements for clean environment
            REQUIREMENTS_FILE="/root/.previous_requirements_hash"
            rm -f "$REQUIREMENTS_FILE"  # Clear previous hash
            
            echo "üì¶ Installing dependencies..."
            pip install -r requirements.txt
            
            # Fix alembic command variable name (typo fix)
            ALEMBIC_CMD="$PWD/venv/bin/alembic"
            
            # Check for multiple Alembic heads
            echo "Checking Alembic migrations..."
            alembic_heads=$($ALEMBIC_CMD heads | grep -v '^$' | wc -l)
            if [ "$alembic_heads" -gt 1 ]; then
                echo "Merging Alembic heads..."
                $ALEMBIC_CMD merge heads -m "merge heads for deployment"
            fi
            
            $ALEMBIC_CMD upgrade head
            echo "‚úì Database migrations completed"
            
            # PM2 process management
            pm2 delete all 2>/dev/null || true
            
            if [ ! -f "ecosystem.config.js" ]; then
               echo "‚ùå ecosystem.config.js not found!"
              exit 1
            fi
            
            echo "Starting application with pm2"
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup
            
            # Verify application started
            if pm2 show bank-statement-analyzer | grep -q "online"; then
                echo "‚úÖ Application started successfully"
            else
                echo "‚ùå Application failed to start"
                pm2 logs bank-statement-analyzer --lines 50
                exit 1
            fi
            
            if pm2 show celery-worker | grep -q "online"; then
                echo "‚úÖ Celery workers started successfully"
            else 
                echo "‚ùå Celery workers failed to start"
                pm2 logs celery-worker --lines 50
                exit 1
            fi