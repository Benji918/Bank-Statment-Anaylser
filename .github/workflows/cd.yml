name: Development Deployment Workflow
description: 'Automated deployment workflow for development branch'

on:
  push:
    branches:
      - dev


jobs:
  dev-deployment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
          

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          echo "Dependencies installed"

      - name: Deploy To Droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DIGITALOCEAN_DROPLET_IP }}
          username: root
          key: ${{ secrets.DIGITALOCEAN_SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ðŸ”„ Starting deployment..."
            
            # Check if the directory exists, if not clone repo
            if [ ! -d "~/Bank-Statment-Anaylser" ]; then
            echo "Repository not found....."
            git clone https://github.com/Benji918/Bank-Statment-Anaylser.git
            fi
            
            cd ~/Bank-Statment-Anaylser
            
            # Ensure we're on the right branch
            git fetch origin dev
            git checkout dev
            git reset --hard origin/dev
             echo "âœ“ Git changes pulled"
            
            # Create or reuse existing environment
            if [ ! -d "venv" ]; then
              python3 -m venv venv
              echo "âœ“ Virtual environment created"
            else 
              echo "âœ“ Using existing virtual environment"
            fi
            
            source venv/scripts/activate
            echo "âœ“ Creating virtual environments"
            
            pip install -r requirements.txt
            echo "âœ“ Dependencies installed"
            
            alembic upgrade head
            echo "âœ“ Database migrations completed"
            
            # Kill any running Uvicorn (ignore errors if none)
            pkill -f "uvicorn app:app" || true
            
            # Start Uvicorn in background
            nohup venv/bin/uvicorn app:app \
            --host 0.0.0.0 \
            --port 8000 \
            --reload False > uvicorn.log 2>&1 &
            
            echo "âœ… Deployed at $(date)"
            
            



      
  




