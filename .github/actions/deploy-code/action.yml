name: 'Deploy Code'
description: 'Deploy application code to the server'

inputs:
  host:
    description: 'Target server host/IP'
    required: true
  username:
    description: 'SSH username'
    required: true
  ssh-key:
    description: 'SSH private key'
    required: true
  env-file:
    description: 'Environment file contents'
    required: true
  branch:
    description: 'Git branch to deploy'
    required: true
  app-directory:
    description: 'Application directory name'
    required: true

  repository-url:
    description: 'Git repository URL'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Pull Repository Changes
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ inputs.host }}
        username: ${{ inputs.username }}
        key: ${{ inputs.ssh-key }}
        script: |
          set -e
          echo "ðŸ“¥ Pulling repository changes..."
          
          cd $HOME/${{ inputs.app-directory }}
          
          # Create .env file on the droplet
          echo "${{ inputs.env-file }}" > .env
          echo "âœ“ Environment file created"
          
          #Initialize the git if .git doesn't exists
          if [ ! -d .git ]; then
            git init
            echo "Git folder created"
            git remote add origin ${{ inputs.repository-url }}
            git fetch origin ${{ inputs.branch }}
            git checkout -b ${{ inputs.branch }}
            git pull origin ${{ inputs.branch }}
          
          else
            echo "Git folder already exists"
            git fetch origin ${{ inputs.branch }}
            git checkout ${{ inputs.branch }}
            git pull origin ${{ inputs.branch }} 
          fi
          echo "âœ“ Git changes pulled successfully"
